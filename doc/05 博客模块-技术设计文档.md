# 博客模块-技术设计文档

## 背景

这个模块主要记录一些用户生产的内容（博客，评论，评价）

## 技术方案

主要考虑的点

- 博客如何分类
- 评论设计如何能体现出评论与博客它其他评论的关系（楼中楼）

### 实体设计

```sql
CREATE TABLE `blog`
(
    `id`         bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `user_id`    bigint(11)          NOT NULL DEFAULT 0 COMMENT '博客的作者',
    `title`      varchar(100)        NOT NULL DEFAULT '' COMMENT '博客标题',
    `is_folder`  tinyint(1)          NOT NULL DEFAULT 0 COMMENT '0: 正常博客，1：博客类别/文件夹',
    `content`    text                         DEFAULT NULL COMMENT '博客的内容',
    `status`     tinyint(4) unsigned NOT NULL DEFAULT 1 COMMENT '博客状态 1:所有人可见 2. 仅自己可见 3. 删除',
    `folder_id`  bigint(11) unsigned NOT NULL DEFAULT 0 COMMENT '博客所属类别/文件夹，0 则无类别',
    `extra`      text                         DEFAULT NULL COMMENT '一些额外的json数据',
    `like_count` bigint(11)          NOT NULL DEFAULT 0 COMMENT '喜欢的人数',
    `created_at` timestamp           NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` timestamp           NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
    primary key (`id`),
    key idx_user_id_status (`user_id`, `status`),
    unique key uniq_created_at (`created_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT ='博客表';

# 可用常用到的一些sql
# 查看所有博客: select * from blog where is_folder = false order by created_at limit 10
# 查询用户所有博客: select * from blog where user_id = x and status = 1 and is_category = 0
# 查询用户所有一级博客与文件夹：select * from where user_id = x and category_id = 0 and status = 1
# 查询用户某个种类（目录下）a 的博客：select * from blog where user_id = x and category = a and status = 1
```

- 设计的想法类似于文件系统中的文件与文件夹。这样博客的分类实现了，还能是无限层级的。使用```is_folder``` 是文件还是文件夹 ```folder_id``` 识别此文件所属文件夹的id

```sql
CREATE TABLE `comment`
(
    `id`           bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `type`         tinyint(4) unsigned NOT NULL DEFAULT 0 COMMENT '评论类型：1. 对博客的评论 2. 对评论的评论 3. 对用户的评论',
    `content`      varchar(255)        not null DEFAULT '' COMMENT '评论的内容',
    `to_id`        bigint(11) unsigned NOT NULL DEFAULT 0 COMMENT '此评论所归属的id,若type是博客，此id是评论的博客',
    `from_user_id` bigint(11) unsigned NOT NULL DEFAULT 0 COMMENT '评论发起者',
    `to_user_id`   bigint(11) unsigned NOT NULL DEFAULT 0 COMMENT '评论所回应的人，若是博客则是写博客的人ID',
    `like_count`   bigint(11)          NOT NULL DEFAULT 0 COMMENT '喜欢的人数',
    `extra`        text                         DEFAULT NULL COMMENT '一些额外的json数据',
    `created_at`   timestamp           NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `deleted_at`   bigint(11)                   DEFAULT 0 COMMENT '删除时间',
    primary key (`id`),
    key idx_belong_id_type_deleted (`to_id`, `type`, `deleted_at`),
    key idx_from_id (`from_user_id`),
    key idx_to_id (`to_user_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT ='评论表';

# 常用的 sql
# 一条博客下的评论：select * from comment where belong_id = x and type = 1 and deleted_at = 0
# 一条评论下的评论: select * from comment where belong_id = x and type = 2 and deleted_at = 0
# 一个用户的发出的评论: select * from comment where from_id = x and deleted_at = 0
# 一个用户收到的评论：select * from comment where to_id = x and deleted_at = 0
```

### 

### .proto idl文件设计

#### 提供的接口如下

- 